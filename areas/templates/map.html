{% load static %}


<!DOCTYPE html>

<!-- Iteration 2-->
<!-- Main HTML-->
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>Safe Explorer</title>
        <link rel="icon" type="image/x-icon" href="{% static 'assets/favicon.ico' %}" />
        <!-- Font Awesome icons (free version)-->
        <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>


        <!-- Google fonts-->
        <link href="https://fonts.googleapis.com/css?family=Catamaran:100,200,300,400,500,600,700,800,900" rel="stylesheet" />
        <link href="https://fonts.googleapis.com/css?family=Lato:100,100i,300,300i,400,400i,700,700i,900,900i" rel="stylesheet" />
        <!-- Core theme CSS (includes Bootstrap)-->

        <!-- Iteration 3: -->
        <link href="{% static 'css/styles.css' %}" rel="stylesheet" />
        <!-- Leaflet Maps Plugin -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
        <!-- Leaflet Geocoding Plugin -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
        <!-- Leaflet Search Plugin -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet-search/dist/leaflet-search.min.css" />  
        <!-- JQuery -->
        <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yEx1q6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
        <script src="jquery-3.7.1.min.js"></script>

        <style>
            #map{
                height: 500px;
                width: 100%;
            }
            .leaflet-container :focus:not(:focus-visible) {
                outline: 0;
              }
            
            .info {
                padding: 6px 8px;
                font: 14px/16px Arial, Helvetica, sans-serif;
                background: white;
                background: rgba(255,255,255,0.8);
                box-shadow: 0 0 15px rgba(0,0,0,0.2);
                border-radius: 5px;
            }
            .info h4 {
                margin: 0 0 5px;
                color: #777;
            }
        </style>
    </head>

    <body>
    <!-- Iteration 3 
    {% load leaflet_tags %}
    {% leaflet_map "map" callback="map_init" %}
    {% leaflet_css %}
    {% leaflet_js %}
        -->
          
        <!-- Iteration 2 --> 
        <!-- Navigation-->
        <nav class="navbar navbar-expand-lg navbar-dark navbar-custom fixed-top">
            <div class="container px-5">
                <!-- Redirect to Landing Page hyperlink --> 
                <a class="navbar-brand" href="/">Safe Explorer</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
                <div class="collapse navbar-collapse" id="navbarResponsive">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item"><a class="nav-link" href="/map">Search for a Location</a></li>
                        <li class="nav-item"><a class="nav-link" href="#!">Sign Up</a></li>
                        <li class="nav-item"><a class="nav-link" href="#!">Log In</a></li>
                    </ul>
                </div>
            </div>
        </nav>

        <!-- Iteration 2 -->  
        <!-- Header-->
        <header class="masthead text-center text-white has-bg-img" style="background-image:url({% static 'assets/img/cork1.jpg' %})">
            <div class="masthead-content has-bg-img">        
                <div class="container px-5">
                    <!-- Iteration 2 -->   
                    <!-- REF: Text Shadow Effect - layering over shadows to make shadow darker (Stackoverflow, 2016) -->
                    <h1 class="masthead-heading mb-0" style="text-shadow: 0 0 32px black, 0 0 32px black, 0 0 32px black, 0 0 32px black">Map Search</h1>
                    <h4 style="text-shadow: 0 0 32px black, 0 0 32px black, 0 0 32px black, 0 0 32px black">Show safety ratings and reviews for any area around the world.</h4>
                </div>
            </div>
        </header>

        <!-- Iteration 2 -->    
        <!-- Search Bar and Location Name-->
        <!-- REF: Working with grids (GetBootstrap, 2023) -->
        <section id="search-bar">
            <div class="container px-5" style="padding-top:30px">
                <div class="row gx-5 align-items-center"> 

                    <!-- Left: Search Bar-->
                    <!-- REF: Search Bar (MD Bootstrap, 2023) --> 
                    <div class="col-lg-6 order-lg-2">                       
                        <div class="input-group rounded container px-5">
                            <input id="external-search" type="search" class="form-control rounded" placeholder="Search" aria-label="Search" aria-describedby="search-addon" />
                            <span  class="input-group-text border-0" id="search-addon">
                            <i class="fas fa-search"></i>
                            </span>
                        </div>
                         
                    </div>

                    <!-- Right: Location Name -->
                    <div class="col-lg-6 order-lg-1">
                        <div class="p-5" style="text-align:center">
                            <h3 class="display-4" id='location-name'>Cork City</h3>
                            <h4>Co. Cork, Ireland</h4>
                        </div>
                    </div>

                </div>
            </div>
        </section>

        <!-- Iteration 3: -->
        <!-- LEAFLET MAP   -->
        <section>                     
            <div class="container px-5">
                <div id= "map"class="row gx-5 align-items-center"></div>
            </div>         
        </section>

  
            <section id="search-bar">
                <div class="container px-5" style="padding-top:30px">
                    <div class="row gx-5 align-items-center"> 
    
                        <!-- Left: Search Bar-->
                        <!-- REF: Search Bar (MD Bootstrap, 2023) --> 
                        <div class="col-lg-6 order-lg-2">                       
                            <div class="input-group rounded container px-5">
                                <button onclick="filterCrime('location_id')" type="button" class="btn btn-primary btn-lg" href="{% url 'crime_page' %}" >See Crime Data</button>
                
                            </div>
                             
                        </div>
    
                        <!-- Right: Location Name -->
                        <div class="col-lg-6 order-lg-1">
                            <div class="p-5" style="text-align:center">
                                <button onclick="filterCrime('location_id')" type="button" class="btn btn-primary btn-lg">See User Reviews</button>
                            </div>
                        </div>
    
                    </div>
                </div>
            </section>

            <section>
                <div class= 'container'>
    
                    {% block table %}
    
                    <h1>Crime List</h1>
    
                <!-- Table with Crime Stats -->
                        <table id="crime-table" class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Location</th>
                                    <th>Crime Type</th>
                                    <th>Occurrences in 2022</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Table rows will be dynamically generated here -->
                            </tbody>
                        </table>
                        
                        <script>
                            var crimeList = JSON.parse('{{ crime_list_json|escapejs }}');
                            
                            // Function to update the HTML table with new data
                            function updateCrimeTable(locationFilter) {
                                var tableBody = document.querySelector('#crime-table tbody');
                                tableBody.innerHTML = ''; // Clear existing table rows
                                
                                // Loop through the crimeList and add rows to the table
                                crimeList.forEach(function(crimeRecord) {
                                    // Only add row if locationFilter matches the policeID
                                    if (crimeRecord.policeID_id == locationFilter) {
                                        var row = tableBody.insertRow();
                                        row.innerHTML = '<td>' + crimeRecord.policeID.policeName + '</td>' +
                                                        '<td>' + crimeRecord.crimeType + '</td>' +
                                                        '<td>' + crimeRecord.value + '</td>';
                                    }
                                });
                            }


                        </script>
                    {% endblock %} 

                </div>
            </section>


        <!-- Iteration 2 -->    
        <!-- AREA ANALYTICS-->
        <section id="area-analytics">
            <div class="container px-5">

                <!-- Analytics Tiles -->
                <div class="row align-items-center"> 
                        <!-- Metric 1 -->
                        <div class="col">
                            <div class="p-5" style="text-align:center">
                                <h2 class="display-4" id="Robberies">{{ my_variable }}</h2>
                                <h3>Robberies</h3>
                                <h6>In 2022</h6>
                            </div>
                        </div>

                        <!-- Metric 2 -->
                        <div class="col">
                            <div class="p-5" style="text-align:center">
                                <h2 class="display-4">34</h2>
                                <h3>Assaults</h3>
                                <h6>In 2022</h6>
                            </div>
                        </div>
                    

                        <!-- Metric 3 -->
                        <div class="col">
                            <div class="p-5" style="text-align:center">
                                <h2 class="display-4">26</h2>
                                <h3>Unsocial Behaviour</h3>
                                <h6>In 2022</h6>
                            </div>
                        </div>

                        <!-- Metric 4 -->
                        <div class="col">
                            <div class="p-5" style="text-align:center">
                                <h2 class="display-4">56</h2>
                                <h3>Drug Related</h3>
                                <h6>In 2022</h6>
                            </div>
                        </div>   
                </div>
            </div>
        </section>    

        <!-- Iteration 4 --> 
        <!-- CRIME STATS -->
        <!-- REF: Styled Tables (Bootstrap, 2024) -->
        <!-- REF: Showing Items fron DB (Codemy.com, 2021) Youtube [18:41] -->
        <section>
            <div class= 'container'>

                {% block content %}

                    <h1>Crime List</h1>

                    <!-- Table with Crime Stats -->
                    <table id="crime-table" class="table table-striped" >
                        <thead>
                        <tr>
                            <th>Location</th>
                            <th>Crime Type</th>
                            <th>Occurences in 2022</th>
                        </tr>
                        </thead>

                  
                        {% for CrimeRecord in crime_list %}
                        {% if CrimeRecord.policeID_id == locationFilter %}
                    <tbody>
                        <tr>
                            <td>{{ CrimeRecord.policeID.policeName }}</td>
                            <td>{{ CrimeRecord.crimeType }}</td>
                            <td>{{ CrimeRecord.value}}</td>
                        </tr>
                    </tbody>
                    

                        {% endif %}
                        {% endfor %}
                
                        
                    </table>

                {% endblock %} 
<!--{% if CrimeRecord.policeID == policeID %} -->
         <!-- {% endif %} -->
            </div>
        </section>


            <!-- Iteration 4 List Sample
                <ul class="list-group list-group-flush">

                    {% for CrimeRecord in crime_list %}   

                    <li class="list-group-item">{{ CrimeRecord.crimeType }}</li>                
                       
                    {% endfor %}

                  </ul>
                -->


        <!-- Footer-->
        <footer class="py-5 bg-black">
            <div class="container px-5"><p class="m-0 text-center text-white small">Copyright &copy; Safe Explorer 2023</p></div>
        </footer>

        <!-- Bootstrap core JS-->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Core theme JS-->
        <script src="{% static 'js/scripts.js' %}"></script>


    </body>
</html>
{% comment  %}
////////////////////////////////////////////////////////////////////////////////
                              JavaScript
////////////////////////////////////////////////////////////////////////////////
{% endcomment %}

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://unpkg.com/leaflet-ajax/dist/leaflet.ajax.min.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script src="https://unpkg.com/leaflet-search/dist/leaflet-search.min.js"></script>

{% comment  %} <script src="./data/CorkDivisions.js"><</script> might be needed at some point {% endcomment %}
<script>

// Iteration 3
// REF: Full Leaflet Tutorial - Youtube [57 mins] (The GIS Hub, 2022)
// Showing Leaflet Base Map
var map = L.map('map').setView([51.898, -8.4788], 12.5);

var osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });
    osm.addTo(map);
     
// Adding Cork divisions from GeoJSON  
var polygonJSON = L.geoJSON.ajax(" {% static 'data/CorkDivisions.geojson' %} ", {
    style: style,  // Add the style function here
    onEachFeature: onEachFeature
}).addTo(map);

// Iteration 3
// COLOR GRADIENT TO SECTOR BASED ON SAFETY RATING
// REF: Leaflet Documentation (Leafletjs.com, 2023) 
function getColor(crimeRating) {
    return crimeRating < 1 ? '#ed0000' :
            crimeRating < 2 ? '#f75200' :
            crimeRating < 3 ? '#ff9100' :
            crimeRating < 4 ? '#ecff5e' :
            crimeRating < 5 ? '#87d904' :
            crimeRating < 6 ? '#17ba02' :
                      '#dbdbdb';
}
// Adjusting style of sectors
function style(feature) {
    return {
        fillColor: getColor(feature.properties.crimeRating),
        color: 'black',
        weight: 1.5,
        opacity: 0.25,
        fillOpacity: 0.45,
    };
}

// Iteration 3
// HOVER/CLICK SECTOR ANIMATION + TOOLTIP
// REF: Full Leaflet Tutorial - Youtube [57 mins] (The GIS Hub, 2022), aslo in 
// Hovering highlights sector 
function highlightFeature(e) {
    var layer = e.target;
    info.update(layer.feature.properties);

    layer.setStyle({
        weight: 8,
        color: 'black',
        dashArray: '',
        fillOpacity: 0.7
    });

    layer.bringToFront();

    // Create the tooltip content
    var properties = layer.feature.properties;
    var tooltipContent = "<b>Area: " + properties.policeName + "</b>" +" <br>" 
        + "Safety Rating: " + properties.crimeRating + "/5";
    // Bind the tooltip to the layer and open it
    layer.bindTooltip(tooltipContent).openTooltip();
}

// Un-hovering removes highlight from sector
function resetHighlight(e) {
    polygonJSON.resetStyle(e.target);
    info.update();
}

// Clicking sector zooms to feature
function zoomToFeature(e) {
    map.fitBounds(e.target.getBounds());
}
/*
function updateCrimeRecords(policeID) {
    $.ajax({
       // url: '/map?policeID=' + policeID, // Update with the correct URL
        type: 'GET',
        success: function(response) {
            var table = $('#crime-table');
            table.empty(); // Clear existing rows

            // Add header row
            table.append('<tr><th>Crime Type</th><th>Occurrences in 2022</th></tr>');

            // Add new rows
            response.crime_list.forEach(function(crimeRecord) {
                table.append('<tr><td>' + crimeRecord.crimeType + '</td><td>' + crimeRecord.value + '</td></tr>');
            });
        },
        error: function(error) {
            console.log('Error:', error);
        }
    });
}

var crimeData = {{ crime_list | safe }};
*/

/*
function showCrime(policeID) {
    // Filter the data
    var filteredData = crimeData.filter(function(record) {
        return record.policeID === policeID;
    });

    // Update the table
    updateCrimeTable(filteredData);
}
*/

// Live hover and click functionality
function onEachFeature(feature, layer) {
    layer.on({
        mouseover: highlightFeature,
        mouseout: resetHighlight,
        click: function(e) {
            // Remove the existing marker
            if (currentMarker) {
                map.removeLayer(currentMarker);
                currentMarker = null;
            }

            // Update the location name
            updateLocationName(feature.properties.policeName);

            // Zoom to the feature
            zoomToFeature(e);

            filterCrime(feature.properties.policeID);
        }
    });
}

// Search Bar within Map
// L.Control.geocoder().addTo(map);

// Iteration 3
// PRINT SEARCHED ADDRESS AS HTML
// REF: ChatGPT - "I'm using leaflet js map and my own created geojson to create polygons/sectors on a map. Depending on what address is searched in the search bar inside the leaflet search bar, i want to change the HTML text 'Location Name' to the corresponding GeoJson  polygons's 'policeName' property if the marker/address is within that polygon boundary i created. Also i don't want it to make duplaicate markers. Here is my exisitng code: x"
var currentMarker = null; // Variable to store the current marker - stops duplicate markers

// Initialize the geocoder control
var geocoder = L.Control.geocoder({ 
    defaultMarkGeocode: false
})
    .on('markgeocode', function(e) {
        var latlng = e.geocode.center;
        var found = false;

        // Loop through each feature in your GeoJSON layer
        polygonJSON.eachLayer(function(layer) {
            if (isMarkerInsidePolygon(latlng, layer)) {
                updateLocationName(layer.feature.properties.policeName);
                found = true;
            }
        });

        if (!found) {
            updateLocationName("This location is currently not supported"); // Message if searched location not inside Cork City 
        }

        // Remove the previous marker if it exists
        if (currentMarker) {
            map.removeLayer(currentMarker);
        }
        
        // Add the new marker and store it in the currentMarker variable
        currentMarker = L.marker(latlng).addTo(map).bindPopup(e.geocode.name).openPopup();
    })
    .addTo(map);

// Check if marker is inside a polygon
function isMarkerInsidePolygon(marker, poly) {
    var inside = false;
    var x = marker.lat, y = marker.lng;
    for (var ii=0;ii<poly.getLatLngs().length;ii++){
        var polyPoints = poly.getLatLngs()[ii];
        for (var i = 0, j = polyPoints.length - 1; i < polyPoints.length; j = i++) {
            var xi = polyPoints[i].lat, yi = polyPoints[i].lng;
            var xj = polyPoints[j].lat, yj = polyPoints[j].lng;

            var intersect = ((yi > y) != (yj > y))
                && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
            if (intersect) inside = !inside;
        }
    }

    return inside;
};

// Iteration 3
// MAP SEARCH FUNCTION 
// REF: Full Leaflet Tutorial - Youtube [57 mins] (The GIS Hub, 2022) + ChatGPT to refine ("I'm using leaflet js map and my own created geojson to create polygons/sectors on a map. Depending on what address is searched in the search bar inside the leaflet search bar, i want to change the HTML text 'Location Name' to the corresponding GeoJson  polygons's 'policeName' property if the marker/address is within that polygon boundary i created. Here is my exisitng code: x")
var searchControl = new L.Control.Search({
    layer: polygonJSON,
    propertyName: 'policeName',
    marker: false,
    moveToLocation: function(latlng, title, map) {
        // map.fitBounds( latlng.layer.getBounds() );
        var zoom = map.getBoundsZoom(latlng.layer.getBounds());
        map.setView(latlng, zoom); // access the zoom
        
    }
});

map.addControl(searchControl);

// Function to update the location name in HTML
function updateLocationName(name) {
    document.getElementById('location-name').textContent = name;
}

function filterCrime(ID) {
    document.getElementById('Robberies').textContent = ID;
    var locationFilter = ID;
    console.log(ID)
    // updateCrimeTable(newCrimeData);
    updateCrimeTable(locationFilter);
}

// Example usage:
var newCrimeData = [
    { location: 'Location 1', type: 'Type 1', value: 10 },
    { location: 'Location 2', type: 'Type 2', value: 5 },
    // Add more data as needed
];

// Iteration 3
// SIDE INFO PANEL
// REF: Leaflet Documentation (Leafletjs.com, 2023) 
var info = L.control();

info.onAdd = function (map) {
    this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
    this.update();
    return this._div;
};
 
info.update = function (props) { // Update side panel based on hovered sector
    this._div.innerHTML = '<h4>Safety Rating</h4>' +  (props ?
        '<b>' + props.policeName + '</b><br/>' 
        + 'Safety Rating: '+ props.crimeRating + '</b><br/>' 
     //   + 'Reviews: '+ props.crimeRating + '</b><br/>' - Next Section
        : 'Hover over a sector');
};

info.addTo(map);


</script>



<!--
REFRERENCES:

Template:
    Template from Bootstrap.com - Startbootstrap.com. (2023). Start Bootstrap. [online] Available at: https://startbootstrap.com/theme/one-page-wonder [Accessed 9 Nov. 2023].
    License: Free to use - https://github.com/startbootstrap/startbootstrap-one-page-wonder/blob/master/LICENSE         

Iteration 2:
    Google for Developers. (2023). The Maps Embed API quickstart. [online] Available at: https://developers.google.com/maps/documentation/embed/quickstart [Accessed 22 Nov. 2023].
    GetBootstrap (2023). Grid system. [online] Getbootstrap.com. Available at: https://getbootstrap.com/docs/4.0/layout/grid/ [Accessed 22 Nov. 2023].
    Stackoverflow (2016). Text outer glow effect using CSS. [online] Stack Overflow. Available at: https://stackoverflow.com/questions/40393497/text-outer-glow-effect-using-css [Accessed 23 Nov. 2023].
    MD Bootstrap (2013). Bootstrap Search - examples & tutorial. [online] MDB - Material Design for Bootstrap. Available at: https://mdbootstrap.com/docs/standard/forms/search/ [Accessed 23 Nov. 2023].

Iteration 3:
    The GIS Hub (2022). Leaflet Full Course || Leaflet Crash Course || Leaflet For Beginners || The GIS Hub. YouTube. Available at: https://www.youtube.com/watch?v=sVVuYUsfb7k [Accessed 7 Jan. 2024].
    Leafletjs.com. (2023). Interactive Choropleth Map - Leaflet - a JavaScript library for interactive maps. [online] Available at: https://leafletjs.com/examples/choropleth/ [Accessed 21 Jan. 2024].
    ChatGPT - "I'm using leaflet js map and my own created geojson to create polygons/sectors on a map. Depending on what address is searched in the search bar inside the leaflet search bar, i want to change the HTML text 'Location Name' to the corresponding GeoJson  polygons's 'policeName' property if the marker/address is within that polygon boundary i created. Also i don't want it to make duplaicate markers. Here is my exisitng code: x"

Iteration 4:
    Codemy.com (2021). Fetch Data From a Database And Output To A Webpage - Django Wednesdays #5. YouTube. Available at: https://www.youtube.com/watch?v=H3joYTIRqKk [Accessed 4 Feb. 2024].
    Bootstrap (2024). Tables. [online] Getbootstrap.com. Available at: https://getbootstrap.com/docs/5.0/content/tables/ [Accessed 4 Feb. 2024].

‌
‌
Images:
    Cork Header Background - Irish Mirror. (2022). Cork claims ‘fittest place’ crown across UK and Ireland. [online] Irish Mirror. Available at: https://www.irishmirror.ie/news/irish-news/health-news/cork-claims-fittest-place-crown-28107536 [Accessed 23 Nov. 2023].



‌-->